<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>관리자 CRUD 기능 테스트</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            padding: 20px;
            max-width: 1200px;
            margin: 0 auto;
        }
        .test-section {
            margin: 20px 0;
            padding: 20px;
            border: 1px solid #ddd;
            border-radius: 4px;
        }
        .test-section h2 {
            margin-top: 0;
            color: #333;
        }
        button {
            padding: 10px 20px;
            margin: 5px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
        }
        .btn-primary {
            background: #4CAF50;
            color: white;
        }
        .btn-danger {
            background: #f44336;
            color: white;
        }
        .btn-warning {
            background: #ff9800;
            color: white;
        }
        .log {
            background: #f5f5f5;
            padding: 10px;
            margin: 10px 0;
            border-radius: 4px;
            white-space: pre-wrap;
            font-family: monospace;
            max-height: 300px;
            overflow-y: auto;
        }
        .success {
            color: #4CAF50;
            font-weight: bold;
        }
        .error {
            color: #f44336;
            font-weight: bold;
        }
        .warning {
            color: #ff9800;
            font-weight: bold;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            margin: 10px 0;
        }
        th, td {
            border: 1px solid #ddd;
            padding: 8px;
            text-align: left;
        }
        th {
            background: #f4f4f4;
        }
    </style>
</head>
<body>
    <h1>관리자 CRUD 기능 테스트</h1>
    
    <!-- 관리자 로그인 섹션 -->
    <div class="test-section">
        <h2>1. 관리자 로그인</h2>
        <button class="btn-primary" onclick="adminLogin()">관리자 로그인</button>
        <button class="btn-warning" onclick="adminLogout()">로그아웃</button>
        <div id="loginStatus" class="log"></div>
    </div>

    <!-- 매물 생성 테스트 -->
    <div class="test-section">
        <h2>2. 테스트 매물 생성</h2>
        <button class="btn-primary" onclick="createTestProperty()">테스트 매물 생성</button>
        <div id="createLog" class="log"></div>
    </div>

    <!-- 매물 수정 테스트 -->
    <div class="test-section">
        <h2>3. 매물 수정 테스트</h2>
        <button class="btn-primary" onclick="updateTestProperty()">마지막 매물 수정</button>
        <div id="updateLog" class="log"></div>
    </div>

    <!-- 소프트 삭제 테스트 -->
    <div class="test-section">
        <h2>4. 소프트 삭제 테스트</h2>
        <button class="btn-danger" onclick="softDeleteProperty()">마지막 매물 삭제</button>
        <div id="deleteLog" class="log"></div>
    </div>

    <!-- 삭제된 매물 조회 -->
    <div class="test-section">
        <h2>5. 삭제된 매물 목록</h2>
        <button class="btn-primary" onclick="loadDeletedProperties()">삭제된 매물 조회</button>
        <div id="deletedList"></div>
    </div>

    <!-- 매물 복구 테스트 -->
    <div class="test-section">
        <h2>6. 매물 복구 테스트</h2>
        <button class="btn-primary" onclick="restoreLastDeleted()">마지막 삭제 매물 복구</button>
        <div id="restoreLog" class="log"></div>
    </div>

    <!-- 영구 삭제 테스트 -->
    <div class="test-section">
        <h2>7. 영구 삭제 테스트</h2>
        <button class="btn-danger" onclick="permanentDeleteProperty()">테스트 매물 영구 삭제</button>
        <div id="permanentLog" class="log"></div>
    </div>

    <!-- Supabase 설정 -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="config.js"></script>
    <script src="supabase-config.js"></script>
    <script src="admin-functions.js"></script>
    
    <script>
        let lastPropertyId = null;
        let lastDeletedId = null;

        // 로그 출력 함수
        function log(elementId, message, type = 'info') {
            const element = document.getElementById(elementId);
            const timestamp = new Date().toLocaleTimeString('ko-KR');
            const className = type === 'success' ? 'success' : type === 'error' ? 'error' : '';
            element.innerHTML += `<span class="${className}">[${timestamp}] ${message}</span>\n`;
            console.log(message);
        }

        // 관리자 로그인
        function adminLogin() {
            sessionStorage.setItem('admin_logged_in', 'true');
            log('loginStatus', '✅ 관리자로 로그인되었습니다.', 'success');
        }

        // 관리자 로그아웃
        function adminLogout() {
            sessionStorage.removeItem('admin_logged_in');
            log('loginStatus', '⚠️ 로그아웃되었습니다.', 'warning');
        }

        // 테스트 매물 생성
        async function createTestProperty() {
            log('createLog', '테스트 매물 생성 중...');
            
            const testData = {
                property_name: `테스트 매물 ${Date.now()}`,
                property_type: '아파트',
                trade_type: '매매',
                status: '거래가능',
                manager: '테스트 담당자',
                price: '100,000',
                address: '서울시 강남구 테스트동',
                dong: '101',
                ho: '501',
                supply_area_sqm: '84',
                supply_area_pyeong: '25',
                floor_current: '5',
                floor_total: '20',
                shared: false,
                register_date: new Date().toISOString().split('T')[0]
            };

            try {
                const result = await window.insertProperty(testData);
                
                if (result.success) {
                    lastPropertyId = result.data.id;
                    log('createLog', `✅ 매물 생성 완료: ID=${lastPropertyId}, 번호=${result.data.property_number}`, 'success');
                } else {
                    log('createLog', `❌ 생성 실패: ${result.error.message}`, 'error');
                }
            } catch (error) {
                log('createLog', `❌ 오류 발생: ${error.message}`, 'error');
            }
        }

        // 매물 수정
        async function updateTestProperty() {
            if (!lastPropertyId) {
                log('updateLog', '❌ 수정할 매물이 없습니다. 먼저 매물을 생성하세요.', 'error');
                return;
            }

            log('updateLog', `매물 수정 중... ID=${lastPropertyId}`);
            
            const updateData = {
                status: '거래완료',
                price: '150,000',
                manager_memo: '테스트 수정 완료'
            };

            try {
                const result = await window.updateProperty(lastPropertyId, updateData);
                
                if (result.success) {
                    log('updateLog', `✅ 매물 수정 완료: 상태=${result.data.status}, 가격=${result.data.price}`, 'success');
                } else {
                    log('updateLog', `❌ 수정 실패: ${result.error.message}`, 'error');
                }
            } catch (error) {
                log('updateLog', `❌ 오류 발생: ${error.message}`, 'error');
            }
        }

        // 소프트 삭제
        async function softDeleteProperty() {
            if (!lastPropertyId) {
                log('deleteLog', '❌ 삭제할 매물이 없습니다. 먼저 매물을 생성하세요.', 'error');
                return;
            }

            log('deleteLog', `매물 삭제 중... ID=${lastPropertyId}`);
            
            try {
                const result = await window.deleteProperty(lastPropertyId);
                
                if (result.success) {
                    lastDeletedId = lastPropertyId;
                    log('deleteLog', `✅ 매물 소프트 삭제 완료: deleted_at=${result.data.deleted_at}`, 'success');
                    lastPropertyId = null;
                } else {
                    log('deleteLog', `❌ 삭제 실패: ${result.error.message}`, 'error');
                }
            } catch (error) {
                log('deleteLog', `❌ 오류 발생: ${error.message}`, 'error');
            }
        }

        // 삭제된 매물 조회
        async function loadDeletedProperties() {
            const container = document.getElementById('deletedList');
            container.innerHTML = '<p>조회 중...</p>';
            
            try {
                const result = await window.getDeletedProperties();
                
                if (result.success && result.data.length > 0) {
                    let html = '<table><thead><tr><th>ID</th><th>매물명</th><th>삭제일시</th><th>상태</th></tr></thead><tbody>';
                    
                    result.data.forEach(prop => {
                        html += `<tr>
                            <td>${prop.id}</td>
                            <td>${prop.property_name}</td>
                            <td>${new Date(prop.deleted_at).toLocaleString('ko-KR')}</td>
                            <td>${prop.status}</td>
                        </tr>`;
                    });
                    
                    html += '</tbody></table>';
                    container.innerHTML = html;
                    
                    if (result.data.length > 0) {
                        lastDeletedId = result.data[0].id;
                    }
                } else if (result.success) {
                    container.innerHTML = '<p class="warning">삭제된 매물이 없습니다.</p>';
                } else {
                    container.innerHTML = `<p class="error">조회 실패: ${result.error.message}</p>`;
                }
            } catch (error) {
                container.innerHTML = `<p class="error">오류: ${error.message}</p>`;
            }
        }

        // 매물 복구
        async function restoreLastDeleted() {
            if (!lastDeletedId) {
                log('restoreLog', '❌ 복구할 매물이 없습니다. 먼저 매물을 삭제하세요.', 'error');
                return;
            }

            log('restoreLog', `매물 복구 중... ID=${lastDeletedId}`);
            
            try {
                const result = await window.restoreProperty(lastDeletedId);
                
                if (result.success) {
                    lastPropertyId = lastDeletedId;
                    lastDeletedId = null;
                    log('restoreLog', `✅ 매물 복구 완료: 상태=${result.data.status}`, 'success');
                } else {
                    log('restoreLog', `❌ 복구 실패: ${result.error.message}`, 'error');
                }
            } catch (error) {
                log('restoreLog', `❌ 오류 발생: ${error.message}`, 'error');
            }
        }

        // 영구 삭제
        async function permanentDeleteProperty() {
            if (!lastDeletedId && !lastPropertyId) {
                log('permanentLog', '❌ 삭제할 매물이 없습니다.', 'error');
                return;
            }

            const targetId = lastDeletedId || lastPropertyId;
            log('permanentLog', `매물 영구 삭제 중... ID=${targetId}`);
            
            try {
                const result = await window.permanentlyDeleteProperty(targetId);
                
                if (result.success) {
                    log('permanentLog', `✅ 매물 영구 삭제 완료`, 'success');
                    if (targetId === lastPropertyId) lastPropertyId = null;
                    if (targetId === lastDeletedId) lastDeletedId = null;
                } else {
                    log('permanentLog', `❌ 영구 삭제 실패: ${result.error.message}`, 'error');
                }
            } catch (error) {
                log('permanentLog', `❌ 오류 발생: ${error.message}`, 'error');
            }
        }

        // 초기화
        window.addEventListener('load', () => {
            setTimeout(() => {
                const isAdmin = sessionStorage.getItem('admin_logged_in') === 'true';
                log('loginStatus', isAdmin ? '✅ 관리자로 로그인되어 있습니다.' : '⚠️ 로그인되어 있지 않습니다.', isAdmin ? 'success' : 'warning');
            }, 1000);
        });
    </script>
</body>
</html>
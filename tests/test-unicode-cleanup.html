<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>Unicode ë¬¸ì œ ì§„ë‹¨ ë° í•´ê²°</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="../supabase-config.js"></script>
    <script src="../clean-invalid-chars.js"></script>
    <style>
        body { font-family: monospace; padding: 20px; }
        .result { margin: 10px 0; padding: 10px; border: 1px solid #ccc; }
        .error { background-color: #ffe6e6; }
        .success { background-color: #e6ffe6; }
        .warning { background-color: #fff3e6; }
        button { margin: 5px; padding: 10px; }
    </style>
</head>
<body>
    <h1>Unicode ë¬¸ì œ ì§„ë‹¨ ë° í•´ê²°</h1>
    
    <div>
        <button onclick="runDiagnostics()">ğŸ” ë¬¸ì œ ì§„ë‹¨</button>
        <button onclick="testCleaning()">ğŸ§¹ ì •ë¦¬ í…ŒìŠ¤íŠ¸</button>
        <button onclick="scanDatabase()">ğŸ“Š ë°ì´í„°ë² ì´ìŠ¤ ìŠ¤ìº”</button>
    </div>
    
    <div id="results"></div>
    
    <script>
        function log(message, type = 'info') {
            const div = document.createElement('div');
            div.className = `result ${type}`;
            div.innerHTML = `<strong>${new Date().toLocaleTimeString()}</strong>: ${message}`;
            document.getElementById('results').appendChild(div);
            console.log(message);
        }
        
        function runDiagnostics() {
            document.getElementById('results').innerHTML = '';
            log('ğŸ” ì§„ë‹¨ ì‹œì‘...', 'info');
            
            // 1. ë¸Œë¼ìš°ì € ì§€ì› í™•ì¸
            try {
                const encoder = new TextEncoder();
                const decoder = new TextDecoder();
                log('âœ… TextEncoder/TextDecoder ì§€ì›ë¨', 'success');
            } catch (err) {
                log('âŒ TextEncoder/TextDecoder ë¯¸ì§€ì›: ' + err.message, 'error');
            }
            
            // 2. JSON ì²˜ë¦¬ í…ŒìŠ¤íŠ¸
            const testData = {
                normal: 'ì •ìƒ í…ìŠ¤íŠ¸',
                emoji: 'ì´ëª¨ì§€ ğŸ˜€ğŸ‰',
                korean: 'í•œê¸€ ê°€ë‚˜ë‹¤',
                broken: '\uD800\uD800\uDC00',  // ì˜ëª»ëœ ì„œë¡œê²Œì´íŠ¸
                control: 'control\x00\x01chars'
            };
            
            try {
                const jsonStr = JSON.stringify(testData);
                log('âœ… JSON ì§ë ¬í™” ì„±ê³µ', 'success');
                
                const parsed = JSON.parse(jsonStr);
                log('âœ… JSON íŒŒì‹± ì„±ê³µ', 'success');
            } catch (err) {
                log('âŒ JSON ì²˜ë¦¬ ì‹¤íŒ¨: ' + err.message, 'error');
            }
            
            // 3. ì •ë¦¬ í•¨ìˆ˜ í…ŒìŠ¤íŠ¸
            if (window.testDataCleaning) {
                window.testDataCleaning();
            }
        }
        
        function testCleaning() {
            log('ğŸ§¹ ì •ë¦¬ í…ŒìŠ¤íŠ¸ ì‹œì‘...', 'info');
            
            const problemStrings = [
                'Normal text',
                'í•œê¸€ í…ìŠ¤íŠ¸',
                'ì´ëª¨ì§€ ğŸ˜€ í¬í•¨',
                '\uD800\uD800 ì˜ëª»ëœ ì„œë¡œê²Œì´íŠ¸',
                '\uDC00 ë‹¨ë… ì„œë¡œê²Œì´íŠ¸',
                'Control\x00\x01\x02characters',
                'í˜¼í•©\uD800í…ìŠ¤íŠ¸\uDC00ë¬¸ì œ'
            ];
            
            problemStrings.forEach((str, i) => {
                try {
                    const cleaned = window.cleanInvalidUnicode(str);
                    const changed = str !== cleaned;
                    
                    log(`${i+1}. ${changed ? 'ğŸ”§' : 'âœ…'} "${str}" â†’ "${cleaned}"`, 
                        changed ? 'warning' : 'success');
                        
                    // JSON ì§ë ¬í™” í…ŒìŠ¤íŠ¸
                    JSON.stringify(cleaned);
                    
                } catch (err) {
                    log(`${i+1}. âŒ ì²˜ë¦¬ ì‹¤íŒ¨: "${str}" - ${err.message}`, 'error');
                }
            });
        }
        
        async function scanDatabase() {
            log('ğŸ“Š ë°ì´í„°ë² ì´ìŠ¤ ìŠ¤ìº” ì‹œì‘...', 'info');
            
            if (!window.supabaseClient) {
                log('âŒ Supabase í´ë¼ì´ì–¸íŠ¸ê°€ ì´ˆê¸°í™”ë˜ì§€ ì•ŠìŒ', 'error');
                return;
            }
            
            try {
                // í…ìŠ¤íŠ¸ í•„ë“œê°€ ìˆëŠ” ë§¤ë¬¼ ì¡°íšŒ
                const { data, error } = await window.supabaseClient
                    .from('properties')
                    .select('id, property_name, address, special_notes, manager_memo')
                    .limit(50);
                
                if (error) {
                    log('âŒ ë°ì´í„° ì¡°íšŒ ì‹¤íŒ¨: ' + error.message, 'error');
                    return;
                }
                
                log(`ğŸ“Š ${data.length}ê°œ ë ˆì½”ë“œ ê²€ì‚¬ ì¤‘...`, 'info');
                
                let problemCount = 0;
                let totalFields = 0;
                
                data.forEach(record => {
                    Object.entries(record).forEach(([key, value]) => {
                        if (typeof value === 'string' && value) {
                            totalFields++;
                            
                            try {
                                // JSON ì§ë ¬í™” í…ŒìŠ¤íŠ¸
                                JSON.stringify(value);
                                
                                // ì •ë¦¬ í•„ìš” ì—¬ë¶€ í™•ì¸
                                const cleaned = window.cleanInvalidUnicode(value);
                                if (value !== cleaned) {
                                    problemCount++;
                                    log(`âš ï¸ ë¬¸ì œ ë°œê²¬ - ID: ${record.id}, í•„ë“œ: ${key}`, 'warning');
                                    log(`   ì›ë³¸: "${value.substring(0, 50)}..."`, 'warning');
                                    log(`   ì •ë¦¬: "${cleaned.substring(0, 50)}..."`, 'warning');
                                }
                            } catch (err) {
                                problemCount++;
                                log(`âŒ JSON ì˜¤ë¥˜ - ID: ${record.id}, í•„ë“œ: ${key}: ${err.message}`, 'error');
                            }
                        }
                    });
                });
                
                log(`ğŸ“Š ìŠ¤ìº” ì™„ë£Œ: ${totalFields}ê°œ í•„ë“œ ì¤‘ ${problemCount}ê°œ ë¬¸ì œ ë°œê²¬`, 
                    problemCount > 0 ? 'warning' : 'success');
                    
                if (problemCount > 0) {
                    log(`ğŸ’¡ í•´ê²°ì±…: cleanInvalidUnicode() í•¨ìˆ˜ë¡œ ë°ì´í„° ì •ë¦¬ í•„ìš”`, 'info');
                }
                
            } catch (err) {
                log('âŒ ìŠ¤ìº” ì¤‘ ì˜¤ë¥˜: ' + err.message, 'error');
            }
        }
        
        // í˜ì´ì§€ ë¡œë“œ í›„ ìë™ ì§„ë‹¨
        window.addEventListener('load', () => {
            setTimeout(() => {
                log('í˜ì´ì§€ ë¡œë“œ ì™„ë£Œ. ì§„ë‹¨ì„ ì‹œì‘í•˜ë ¤ë©´ ë²„íŠ¼ì„ í´ë¦­í•˜ì„¸ìš”.', 'info');
            }, 2000);
        });
    </script>
</body>
</html>
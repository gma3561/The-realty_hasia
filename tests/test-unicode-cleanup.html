<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>Unicode 문제 진단 및 해결</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="../supabase-config.js"></script>
    <script src="../clean-invalid-chars.js"></script>
    <style>
        body { font-family: monospace; padding: 20px; }
        .result { margin: 10px 0; padding: 10px; border: 1px solid #ccc; }
        .error { background-color: #ffe6e6; }
        .success { background-color: #e6ffe6; }
        .warning { background-color: #fff3e6; }
        button { margin: 5px; padding: 10px; }
    </style>
</head>
<body>
    <h1>Unicode 문제 진단 및 해결</h1>
    
    <div>
        <button onclick="runDiagnostics()">🔍 문제 진단</button>
        <button onclick="testCleaning()">🧹 정리 테스트</button>
        <button onclick="scanDatabase()">📊 데이터베이스 스캔</button>
    </div>
    
    <div id="results"></div>
    
    <script>
        function log(message, type = 'info') {
            const div = document.createElement('div');
            div.className = `result ${type}`;
            div.innerHTML = `<strong>${new Date().toLocaleTimeString()}</strong>: ${message}`;
            document.getElementById('results').appendChild(div);
            console.log(message);
        }
        
        function runDiagnostics() {
            document.getElementById('results').innerHTML = '';
            log('🔍 진단 시작...', 'info');
            
            // 1. 브라우저 지원 확인
            try {
                const encoder = new TextEncoder();
                const decoder = new TextDecoder();
                log('✅ TextEncoder/TextDecoder 지원됨', 'success');
            } catch (err) {
                log('❌ TextEncoder/TextDecoder 미지원: ' + err.message, 'error');
            }
            
            // 2. JSON 처리 테스트
            const testData = {
                normal: '정상 텍스트',
                emoji: '이모지 😀🎉',
                korean: '한글 가나다',
                broken: '\uD800\uD800\uDC00',  // 잘못된 서로게이트
                control: 'control\x00\x01chars'
            };
            
            try {
                const jsonStr = JSON.stringify(testData);
                log('✅ JSON 직렬화 성공', 'success');
                
                const parsed = JSON.parse(jsonStr);
                log('✅ JSON 파싱 성공', 'success');
            } catch (err) {
                log('❌ JSON 처리 실패: ' + err.message, 'error');
            }
            
            // 3. 정리 함수 테스트
            if (window.testDataCleaning) {
                window.testDataCleaning();
            }
        }
        
        function testCleaning() {
            log('🧹 정리 테스트 시작...', 'info');
            
            const problemStrings = [
                'Normal text',
                '한글 텍스트',
                '이모지 😀 포함',
                '\uD800\uD800 잘못된 서로게이트',
                '\uDC00 단독 서로게이트',
                'Control\x00\x01\x02characters',
                '혼합\uD800텍스트\uDC00문제'
            ];
            
            problemStrings.forEach((str, i) => {
                try {
                    const cleaned = window.cleanInvalidUnicode(str);
                    const changed = str !== cleaned;
                    
                    log(`${i+1}. ${changed ? '🔧' : '✅'} "${str}" → "${cleaned}"`, 
                        changed ? 'warning' : 'success');
                        
                    // JSON 직렬화 테스트
                    JSON.stringify(cleaned);
                    
                } catch (err) {
                    log(`${i+1}. ❌ 처리 실패: "${str}" - ${err.message}`, 'error');
                }
            });
        }
        
        async function scanDatabase() {
            log('📊 데이터베이스 스캔 시작...', 'info');
            
            if (!window.supabaseClient) {
                log('❌ Supabase 클라이언트가 초기화되지 않음', 'error');
                return;
            }
            
            try {
                // 텍스트 필드가 있는 매물 조회
                const { data, error } = await window.supabaseClient
                    .from('properties')
                    .select('id, property_name, address, special_notes, manager_memo')
                    .limit(50);
                
                if (error) {
                    log('❌ 데이터 조회 실패: ' + error.message, 'error');
                    return;
                }
                
                log(`📊 ${data.length}개 레코드 검사 중...`, 'info');
                
                let problemCount = 0;
                let totalFields = 0;
                
                data.forEach(record => {
                    Object.entries(record).forEach(([key, value]) => {
                        if (typeof value === 'string' && value) {
                            totalFields++;
                            
                            try {
                                // JSON 직렬화 테스트
                                JSON.stringify(value);
                                
                                // 정리 필요 여부 확인
                                const cleaned = window.cleanInvalidUnicode(value);
                                if (value !== cleaned) {
                                    problemCount++;
                                    log(`⚠️ 문제 발견 - ID: ${record.id}, 필드: ${key}`, 'warning');
                                    log(`   원본: "${value.substring(0, 50)}..."`, 'warning');
                                    log(`   정리: "${cleaned.substring(0, 50)}..."`, 'warning');
                                }
                            } catch (err) {
                                problemCount++;
                                log(`❌ JSON 오류 - ID: ${record.id}, 필드: ${key}: ${err.message}`, 'error');
                            }
                        }
                    });
                });
                
                log(`📊 스캔 완료: ${totalFields}개 필드 중 ${problemCount}개 문제 발견`, 
                    problemCount > 0 ? 'warning' : 'success');
                    
                if (problemCount > 0) {
                    log(`💡 해결책: cleanInvalidUnicode() 함수로 데이터 정리 필요`, 'info');
                }
                
            } catch (err) {
                log('❌ 스캔 중 오류: ' + err.message, 'error');
            }
        }
        
        // 페이지 로드 후 자동 진단
        window.addEventListener('load', () => {
            setTimeout(() => {
                log('페이지 로드 완료. 진단을 시작하려면 버튼을 클릭하세요.', 'info');
            }, 2000);
        });
    </script>
</body>
</html>